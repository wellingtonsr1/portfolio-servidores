###################################################################################################################################################
#                                           Passo a Passo para Criar um Servidor de Arquivos usando o SAMBA
###################################################################################################################################################
#
# Este "Passo a passo" tem como objetivo demonstrar a configuração de um servidor de arquivos, permitindo o compartilhamento seguro de dados em 
# uma rede local ou integrada a um domínio do Active Directory (AD). A configuração será baseada no Samba, um software amplamente utilizado para 
# compartilhamento de arquivos em redes Windows e Linux.
#
# 1. Pré-requisitos
#    Antes de executar este script, certifique-se de que:
#
# - O sistema operacional é uma distribuição Linux compatível (Debian, Ubuntu, CentOS, etc.).
# - O usuário tem permissões administrativas (sudo).
# - O servidor possui conectividade com a rede.
# 
# 2. Etapas da Configuração
#    O processo de configuração do servidor de arquivos envolve os seguintes passos:
#
# - Atualização do sistema: Garante que os pacotes essenciais estejam atualizados.
# - Instalação do Samba e dependências: Instalação dos pacotes necessários para o compartilhamento de arquivos.
# - Criação dos diretórios compartilhados: Definição das pastas que serão disponibilizadas para os usuários.
# - Configuração do smb.conf: Ajuste das permissões, grupos e regras de acesso ao compartilhamento.
# - Configuração de permissões de usuário e grupo: Definição de permissões para controle de acesso adequado.
# - Integração com o Active Directory (opcional): Se aplicável, permite autenticação com usuários do AD.
# - Reinício dos serviços e testes: Ativação do Samba e validação do compartilhamento na rede.
#
###################################################################################################################################################

OBS: Há um script (install-samba.sh) que automatiza esse processo.

1. Atualize o sistema
Antes de começar, é importante garantir que o sistema esteja atualizado.

  sudo apt update && sudo apt upgrade -y

2. Instale o Samba e os pacotes necessários.

  sudo apt install samba winbind libnss-winbind libpam-winbind smbclient -y

3. Após a instalação, você precisa configurar o Samba para compartilhar diretórios.

3.1 Faça um backup do arquivo de configuração original:

    sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.old
  
3.2 Edite o arquivo de configuração do Samba:

    sudo nano /etc/samba/smb.conf
   
3.3 Adicione um compartilhamento ao arquivo:

   Aqui está um exemplo de configuração para compartilhar um diretório chamado `compartilhado`:

   # Insira essa diretiva para Integrar o servidor de arquivos com o AD
   [global]
   
   workgroup = exemplo #Substitua 'exemplo' pelo domínio real.
   log file = /var/log/samba/log.%m
   syslog = 0
   server role = standalone server
   map to guest = bad user
   security = ADS
   realm = EXEMPLO.COM.BR
   netbios name = FILESERVER
   server role = member server
   idmap config * : backend = tdb
   idmap config * : range = 10000-20000
   winbind use default domain = yes
   winbind offline logon = yes
   winbind enum users = yes
   winbind enum groups = yes
   template shell = /bin/bash


   [compartilhado]
   path = /srv/compartilhado
   browseable = yes
   writable = yes
   valid users = usuario


   - [compartilhado]: Nome do compartilhamento que aparecerá na rede.
   - path: Caminho do diretório que será compartilhado.
   - browseable: Define se o compartilhamento será visível na rede.
   - writable: Define se os usuários podem escrever no diretório.
   - valid users: Especifica os usuários que têm acesso ao compartilhamento.

   # Insira essa diretiva para cada setor que desejar criar um compartilhamento.
   # Fazendo as devidas alterações.
   [TI]
   path = /srv/ti
   browseable = yes
   writable = yes
   available = yes
   valid users = @exemplo\TI

3.4 Salve e feche o arquivo (no nano, pressione `CTRL + X`, depois `Y` e `Enter` ou use o vim).

4. Criar o diretório compartilhado
4.1 Crie o diretório que será compartilhado e defina as permissões adequadas.

   sudo mkdir -p /srv/compartilhado
   sudo chmod -R 775 /srv/compartilhado
   sudo chown -R nobody:nogroup /srv/compartilhado
     
5. Unir o Servidor ao Domínio

5.1Antes de unir ao AD, configure o DNS para apontar para um controlador de domínio:

   sudo nano /etc/resolv.conf

5.2 Adicione:

   nameserver IP_DO_AD
   search SEU_DOMINIO.COM.BR

5.3 Depois, reinicie os serviços:

   sudo systemctl restart smbd nmbd winbind

5.4 Agora, ingresse o servidor ao domínio:
   sudo net ads join -U Administrador


5.5 Se o ingresso foi bem-sucedido, teste com:

   wbinfo -u  # Lista usuários do AD
   wbinfo -g  # Lista grupos do AD


6. Adicionar um usuário ao Samba. Este usuário deve ser um usuário existente no sistema.

6.1 Crie um usuário no sistema (se ainda não existir):

   sudo adduser usuario
  
6.2 Adicione o usuário ao Samba:

   sudo smbpasswd -a usuario
 
   OBS: Você será solicitado a definir uma senha para o usuário no Samba.

7. Após configurar tudo, reinicie o serviço do Samba para aplicar as mudanças.

   sudo systemctl restart smbd

8. Configurar o firewall (opcional)
   - Se você estiver usando um firewall, certifique-se de permitir o tráfego do Samba.

   sudo ufw allow samba

9. Agora, você pode testar o compartilhamento a partir de outro computador na rede.

9.1 No Windows:
   - Abra o Explorador de Arquivos.
   - Na barra de endereços, digite `\\endereco_ip_do_servidor` e pressione Enter.
   - Insira o nome de usuário e senha do Samba quando solicitado.

9.2 No Linux:
   - Você pode usar o comando `smbclient` para acessar o compartilhamento:
     
     smbclient //endereco_ip_do_servidor/compartilhado -U usuario
    
10. Configurações adicionais (opcional)
    - Se você precisar de mais configurações, como compartilhar impressoras ou ajustar permissões mais específicas, 
    consulte a documentação oficial do Samba ou edite o arquivo `/etc/samba/smb.conf` conforme necessário.


Conclusão:
   Agora você tem um servidor de arquivos básico configurado usando o Samba no Debian 12. Você pode adicionar mais 
   compartilhamentos ou ajustar as configurações conforme necessário para atender às suas necessidades.
   
   
   
